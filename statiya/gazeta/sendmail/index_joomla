<p><strong>Скачиваем исходники </strong></p>
<table border="1">
<tbody>
<tr>
<td><a href="http://dag.wieers.com/rpm/packages/clamav/clamav-0.92.1-1.rf.src.rpm"><span style="color: green; font-size:2 x-small;"><strong>clamav-0.92.1-1.rf.src.rpm</strong></span></a></td>
</tr>
<tr>
<td><a href="http://download.fedora.redhat.com/pub/fedora/linux/releases/8/Everything/i386/os/Packages/spamass-milter-0.3.1-5.fc8.i386.rpm"><span style="color: green; font-size:2 x-small;"><strong>spamass-milter-0.3.1-5.fc8.i386.rpm</strong></span></a></td>
</tr>
</tbody>
</table>
<p> </p>
<p><strong><span style="color: blue; font-size: small;">Установка </span></strong></p>
<p><span style="color: red;"><strong>1.1</strong></span> уже должны быть установлены вот эти пакеты: <br /><span style="color: blue;">spamassassin-3.1.9-1.el5.i386.rpm</span> <br /><span style="color: blue;">sendmail-8.13.8-2.el5.i386.rpm</span> <br /><span style="color: blue;">sendmail-devel-8.13.8-2.el5.i386.rpm</span> <br /><span style="color: blue;">sendmail-cf-8.13.8-2.el5.i386.rpm</span> <br /><span style="color: blue;">dovecot-1.0-1.2.rc15.el5.i386.rpm</span> <br /><span style="color: blue;">spamass-milter-0.3.1-5.fc8.i386.rpm</span></p>
<p><span style="color: red;"><strong>1.2</strong></span> Собираем rpm для clamav:</p>
<div class="codeheader">/root/</div>
<div class="code">[root@localhost ~]# rpmbuild --rebuild clamav-0.92-1.rf.src.rpm<br /> Устанавливается clamav-0.92-1.rf.src.rpm<br /> предупреждение: InstallSourcePackage: Заголовок V3 DSA signature: NOKEY, key ID 6b8d79e6<br /> предупреждение: пользователь dag не существует - используется root<br /> предупреждение: группа dag не существует - используется root<br /> предупреждение: пользователь dag не существует - используется root<br /> предупреждение: группа dag не существует - используется root<br /> предупреждение: пользователь dag не существует - используется root<br /> предупреждение: группа dag не существует - используется root<br /> предупреждение: пользователь dag не существует - используется root<br /> предупреждение: группа dag не существует - используется root<br /> Выполняется(%prep): /bin/sh -e /var/tmp/rpm-tmp.66639<br /> + umask 022<br /> + cd /usr/src/redhat/BUILD<br /> + LANG=C<br /> + export LANG<br /> + unset DISPLAY<br /> + cd /usr/src/redhat/BUILD<br /> + rm -rf clamav-0.92<br /> + tar -xvvf -<br /> + /bin/gzip -dc /usr/src/redhat/SOURCES/clamav-0.92.tar.gz<br /> drwxrwxrwx 1000/1000         0 2007-12-13 02:32:38 clamav-0.92/<br /> -rw-r--r-- 1000/1000        53 2007-12-06 15:59:10 clamav-0.92/FAQ<br /> drwxrwxrwx 1000/1000         0 2007-12-13 02:32:38 clamav-0.92/etc/<br /> -rw-r--r-- 1000/1000      1112 2007-12-06 15:59:09 clamav-0.92/etc/Makefile.am<br /> -rw-r--r-- 1000/1000     10262 2007-12-13 02:06:48 clamav-0.92/etc/Makefile.in<br /> -rw-r--r-- 1000/1000      9062 2007-12-06 15:59:09 clamav-0.92/etc/clamd.conf<br /> -rw-r--r-- 1000/1000      3934 2007-12-06 15:59:09 clamav-0.92/etc/freshclam.conf<br /> -rw-r--r-- 1000/1000        24 2007-12-06 15:59:10 clamav-0.92/BUGS<br /> -rw-r--r-- 1000/1000       473 2007-12-13 01:32:54 clamav-0.92/NEWS<br /> drwxrwxrwx 1000/1000         0 2007-12-13 02:32:38 clamav-0.92/docs/<br /> ..................................................................<br /> Записан: /usr/src/redhat/RPMS/i386/clamav-0.92-1.rf.i386.rpm<br /> Записан: /usr/src/redhat/RPMS/i386/clamd-0.92-1.rf.i386.rpm<br /> Записан: /usr/src/redhat/RPMS/i386/clamav-milter-0.92-1.rf.i386.rpm<br /> Записан: /usr/src/redhat/RPMS/i386/clamav-db-0.92-1.rf.i386.rpm<br /> Записан: /usr/src/redhat/RPMS/i386/clamav-devel-0.92-1.rf.i386.rpm<br /> Записан: /usr/src/redhat/RPMS/i386/clamav-debuginfo-0.92-1.rf.i386.rpm<br /> Выполняется(%clean): /bin/sh -e /var/tmp/rpm-tmp.95040<br /> + umask 022<br /> + cd /usr/src/redhat/BUILD<br /> + cd clamav-0.92<br /> + /bin/rm -rf /var/tmp/clamav-0.92-1.rf-root<br /> + exit 0<br /> Выполняется(--clean): /bin/sh -e /var/tmp/rpm-tmp.50391<br /> + umask 022<br /> + cd /usr/src/redhat/BUILD<br /> + rm -rf clamav-0.92<br /> + exit 0<br /> <br /></div>
<p><br />Установка clamav</p>
<div class="codeheader">/usr/src/redhat/RPMS/i386/</div>
<div class="code">[root@localhost i386]# ls | grep clam<br /> clamav-0.92-1.rf.i386.rpm<br /> clamav-db-0.92-1.rf.i386.rpm<br /> clamav-debuginfo-0.92-1.rf.i386.rpm<br /> clamav-devel-0.92-1.rf.i386.rpm<br /> clamav-milter-0.92-1.rf.i386.rpm<br /> clamd-0.92-1.rf.i386.rpm<br /> [root@localhost i386]# rpm -ihv clam*.rpm<br /> Подготовка...     ########################################### [100%]<br /> 1:clamav-db              ########################################### [ 17%]<br /> 2:clamav                 ########################################### [ 33%]<br /> 3:clamd                  ########################################### [ 50%]<br /> 4:clamav-debuginfo       ########################################### [ 67%]<br /> 5:clamav-devel           ########################################### [ 83%]<br /> 6:clamav-milter          ########################################### [100%]</div>
<p> </p>
<p><strong><span style="color: blue; font-size: small;">Настройка</span></strong></p>
<p><span style="color: red;"><strong>2.1</strong></span> Создадим троих пользователей</p>
<div class="codeheader">/etc/mail/spamassassin</div>
<div class="code">[root@localhost spamassassin]# useradd slava1 -s /sbin/nologin -g users -d /home/slava1<br /> [root@localhost spamassassin]# useradd slava2 -s /sbin/nologin -g users -d /home/slava2<br /> [root@localhost spamassassin]# useradd spam -s /sbin/nologin -g users -d /home/spam</div>
<p><br /> <span style="color: red;"><strong>2.2</strong></span> spamassassin</p>
<div class="codeheader">/etc/mail/spamassassin</div>
<div class="code">[root@localhost spamassassin]# cat local.cf<br /> # These values can be overridden by editing ~/.spamassassin/user_prefs.cf<br /> # (see spamassassin(1) for details)<br /> <br /><br /> # These should be safe assumptions and allow for simple visual sifting<br /> # without risking lost emails.<br /> <br /><br /> #Вводим нашу подсеть в группу доверенных<br /> trusted_networks 192.168.50.50.0/24 127/8<br /> trusted_networks 127.<br /> whitelist_from localhost<br /> <br /><br /> #Устанавливаем порог спама 8<br /> required_hits 8.0<br /> report_safe 0<br /> <br /><br /> #Добавляем к теме письма<br /> rewrite_header Subject [SPAM]<br /> add_header all Report _REPORT_<br /> <br /><br /> whitelist_from localhost<br /> whitelist_from root<br /> whitelist_from MAILER-DAEMON<br /> whitelist_from *@spacedust.ru<br /> <br /><br /> #Скидываем весь спам юзеру spam<br /> all_spam_to spam@spacedust.ru</div>
<p><br /> <span style="color: red;"><strong>2.3</strong></span> Создаем фаил sendmail.mc</p>
<div class="codeheader">/etc/mail/</div>
<div class="code">divert(-1)dnl<br /> include(`/usr/share/sendmail-cf/m4/cf.m4')dnl<br /> VERSIONID(`setup for linux')dnl<br /> OSTYPE(linux)dnl<br /> DOMAIN(generic)dnl<br /> FEATURE(use_cw_file)dnl<br /> FEATURE(use_ct_file)dnl<br /> define(`confCW_FILE', `-o /etc/mail/local-host-names')dnl<br /> FEATURE(mailertable, `hash -o /etc/mail/mailertable')dnl<br /> FEATURE(access_db, `hash -o -T /etc/mail/access')dnl<br /> FEATURE(virtusertable, `hash -o /etc/mail/virtusertable')dnl<br /> FEATURE(local_procmail, `', `procmail -t -Y -a $h -d $u')dnl<br /> FEATURE(redirect)dnl<br /> FEATURE(always_add_domain)dnl<br /> define(`PROCMAIL_MAILER_PATH',`/usr/bin/procmail')dnl<br /> define(`ALIAS_FILE', `/etc/aliases')dnl<br /> define(`STATUS_FILE', `/var/log/mail/statistics')dnl<br /> define(`confTO_IDENT', `0')dnl<br /> define(`confTO_HELO', `1m')dnl<br /> define(`confTO_MAIL', `1m')dnl<br /> define(`confTO_RCPT', `1m')dnl<br /> FEATURE(blacklist_recipients)dnl<br /> FEATURE(`dnsbl',`sb1.spamhaus.org')dnl<br /> FEATURE(`dnsbl', `relay.ordb.org')dnl<br /> FEATURE(`dnsbl', `dul.ru')dnl<br /> FEATURE(`dnsbl', `bl.spamcop.net')dnl<br /> define(`confMAX_MESSAGE_SIZE', `12500000')dnl<br /> define(`confMAX_DAEMON_SHILDREN', `45')dnl<br /> define(`confPRIVACY_FLAGS', `authwarnings,novrfy,noexpn,restrictqrun')dnl<br /> dnl# SpamAssassin + ClamAv<br /> INPUT_MAIL_FILTER(`spamassassin',`S=local:/var/run/spamass-milter/spamass-milter.sock, F=T, T=C:15m;S:4m;R:4m;E:10m')dnl<br /> INPUT_MAIL_FILTER(`clmilter',`S=local:/var/clamav/clmilter.socket, F=T, T=C:15m;S:4m;R:4m;E:10m')dnl<br /> define(`confMILTER_MACROS_CONNECT',`t, b, j, _, {daemon_name}, {if_name}, {if_addr}')dnl<br /> define(`confMILTER_MACROS_HELO',`s, {tls_version}, {cipher}, {cipher_bits}, {cert_subject}, {cert_issuer}')dnl<br /> define(`confMILTER_LOG_LEVEL',`6')dnl<br /> define(`confINPUT_MAIL_FILTERS', `spamassassin,clmilter')dnl<br /> FEATURE(`relay_based_on_MX')dnl<br /> FEATURE(`relay_hosts_only')dnl<br /> MASQUERADE_AS(spacedust.ru)dnl<br /> MAILER(procmail)dnl<br /> MAILER(smtp)dnl<br /> divert(0)dnl</div>
<p><br /> Очищаем буфер и создаем начало для нового файла макроса</p>
<div class="code">divert(-1)dnl<br /> divert(0)dnl</div>
<p><br /> Подключаем макропроцессор m4, prochmail и SpamAssassin + Clamav</p>
<div class="code">include(`/usr/share/sendmail-cf/m4/cf.m4')dnl<br /> <br /><br /> FEATURE(local_procmail, `', `procmail -t -Y -a $h -d $u')dnl<br /> MAILER(procmail)dnl<br /> <br /><br /> INPUT_MAIL_FILTER(`spamassassin',`S=local:/var/run/spamass-milter/spamass-milter.sock, F=T, T=C:15m;S:4m;R:4m;E:10m')dnl<br /> INPUT_MAIL_FILTER(`clmilter',`S=local:/var/clamav/clmilter.socket, F=T, T=C:15m;S:4m;R:4m;E:10m')dnl<br /> define(`confMILTER_MACROS_CONNECT',`t, b, j, _, {daemon_name}, {if_name}, {if_addr}')dnl<br /> define(`confMILTER_MACROS_HELO',`s, {tls_version}, {cipher}, {cipher_bits}, {cert_subject}, {cert_issuer}')dnl<br /> define(`confMILTER_LOG_LEVEL',`6')dnl<br /> define(`confINPUT_MAIL_FILTERS', `spamassassin,clmilter')dnl<br /> <br /></div>
<p><br />Указываем операционную систему</p>
<div class="code">OSTYPE(linux)dnl</div>
<p><br /> Включаем доменное имя во все адреса</p>
<div class="code">FEATURE(always_add_domain)dnl</div>
<p><br /> Выставляем timeout для команд IDENT, HELO, MAIL, RCPT</p>
<div class="code">define(`confTO_IDENT', `0')dnl<br /> define(`confTO_HELO', `1m')dnl<br /> define(`confTO_MAIL', `1m')dnl<br /> define(`confTO_RCPT', `1m')dnl</div>
<p><br /> Включаем проверку по черным спискам</p>
<div class="code">FEATURE(blacklist_recipients)dnl<br /> FEATURE(`dnsbl',`sb1.spamhaus.org')dnl<br /> FEATURE(`dnsbl', `relay.ordb.org')dnl<br /> FEATURE(`dnsbl', `dul.ru')dnl<br /> FEATURE(`dnsbl', `bl.spamcop.net')dnl</div>
<p><br /> Sendamil будет принимать почту на основе MX записей DNS</p>
<div class="code">FEATURE(`relay_based_on_MX')dnl</div>
<p><br /> Параметр redirect позволяет sendmail выдавать сообщение об ошибке для пользователей, адреса которых были перенаправлены на другой хост с помощью метки .REDIRECT.</p>
<div class="code">FEATURE(redirect)dnl</div>
<p><br /> Параметр relay_hosts_only позволяет программе sendmail использовать в базе данных access.db имена хостов и объявлять их с помощью метки RELAY</p>
<div class="code">FEATURE(`relay_hosts_only')dnl</div>
<p><br /> Параметр use_ct_file позволяет программе sendmail, запущенной с параметром -f, читать из файла доверенных пользователей системы <br />Параметр use_cw_file позволяет программе sendmail читать из файла альтернативных имен для почтового сервера</p>
<div class="code">FEATURE(use_cw_file)dnl<br /> FEATURE(use_ct_file)dnl</div>
<p> </p>
<p><span style="color: red;"><strong>2.3</strong></span> Правим файлы</p>
<div class="codeheader">/etc/mail/</div>
<div class="code">[root@localhost mail]# cat local-host-names<br /> # local-host-names - include all aliases for your machine here.<br /> spacedust.ru</div>
<p> </p>
<div class="codeheader">/etc/mail/</div>
<div class="code">[root@localhost mail]# cat access<br /> # Check the /usr/share/doc/sendmail/README.cf file for a description<br /> # of the format of this file. (search for access_db in that file)<br /> # The /usr/share/doc/sendmail/README.cf is part of the sendmail-doc<br /> # package.<br /> #<br /> # by default we allow relaying from localhost...<br /> Connect:localhost.localdomain           RELAY<br /> Connect:localhost                       RELAY<br /> Connect:127.0.0.1                       RELAY<br /> 192.168.50                              RELAY<br /> To:root@                                OK<br /> To:slava1@                              OK<br /> To:slava2@                              OK<br /> To:spacedust.ru                         ERROR:"550 User unknown"</div>
<p> </p>
<p><strong><span style="color: blue; font-size: small;">Запускаем и проверяем</span></strong></p>
<div class="codeheader">/etc/mail/</div>
<div class="code">[root@localhost mail]# <span style="color: red;">make</span><br /> [root@localhost mail]# <span style="color: red;">service clamd start</span><br /> Starting Clam AntiVirus Daemon:                            [  OK  ]<br /> [root@localhost mail]# service clamav-milter start<br /> Starting Clamav Milter Daemon: Your LANG environment variable is set to 'ru_RU.UTF-8'<br /> This is known to cause problems for some clamav-milter installations.<br /> If you get failures with temporary files, please try again with LANG unset.<br /> LibClamAV Warning: **************************************************<br /> LibClamAV Warning: ***  The virus database is older than 7 days!  ***<br /> LibClamAV Warning: ***   Please update it as soon as possible.    ***<br /> LibClamAV Warning: **************************************************<br /> Loaded ClamAV 0.92/5110/Wed Dec 12 23:42:31 2007<br /> ClamAV: Protecting against 345659 viruses<br /> [  OK  ]<br /> [root@localhost mail]# <span style="color: red;">freshclam</span><br /> ClamAV update process started at Sun Apr 13 14:08:14 2008<br /> WARNING: Your ClamAV installation is OUTDATED!<br /> WARNING: Local version: 0.92 Recommended version: 0.92.1<br /> DON'T PANIC! Read http://www.clamav.net/support/faq<br /> Downloading main-46.cdiff [100%]<br /> main.inc updated (version: 46, sigs: 231834, f-level: 26, builder: sven)<br /> WARNING: Your ClamAV installation is OUTDATED!<br /> WARNING: Current functionality level = 25, recommended = 26<br /> DON'T PANIC! Read http://www.clamav.net/support/faq<br /> WARNING: getfile: daily-5111.cdiff not found on remote server (IP: 62.181.41.8)<br /> ERROR: getpatch: Can't download daily-5111.cdiff from db.ru.clamav.net<br /> WARNING: getfile: daily-5111.cdiff not found on remote server (IP: 217.147.29.149)<br /> ERROR: getpatch: Can't download daily-5111.cdiff from db.ru.clamav.net<br /> WARNING: getfile: daily-5111.cdiff not found on remote server (IP: 217.20.175.83)<br /> ERROR: getpatch: Can't download daily-5111.cdiff from db.ru.clamav.net<br /> WARNING: Incremental update failed, trying to download daily.cvd<br /> Downloading daily.cvd [100%]<br /> daily.cvd updated (version: 6753, sigs: 22848, f-level: 26, builder: ccordes)<br /> WARNING: Your ClamAV installation is OUTDATED!<br /> WARNING: Current functionality level = 25, recommended = 26<br /> DON'T PANIC! Read http://www.clamav.net/support/faq<br /> Database updated (254682 signatures) from db.ru.clamav.net (IP: 213.219.244.126)<br /> Clamd successfully notified about the update.<br /> [root@localhost mail]# <span style="color: red;">service spamassassin start</span><br /> Запускается spamd:                                         [  OK  ]<br /> [root@localhost mail]# <span style="color: red;">service spamass-milter start</span><br /> Starting SpamAssassin milter (spamass-milter):             [  OK  ]<br /> [root@localhost mail]# <span style="color: red;">service sendmail start</span><br /> Запускается sendmail:                                      [  OK  ]<br /> Запускается sm-client:                                     [  OK  ]<br /> [root@localhost mail]# <span style="color: red;">service dovecot start</span><br /> Запускается Dovecot Imap:                                  [  OK  ]</div>
<p><br /><br /></p>
<div class="code">Apr 13 14:14:35 localhost sendmail[5579]: gethostbyaddr(192.168.50.175) failed: 1<br /> Apr 13 14:14:35 localhost sendmail[5579]: alias database /etc/aliases rebuilt by root<br /> Apr 13 14:14:35 localhost sendmail[5579]: /etc/aliases: 76 aliases, longest 10 bytes, 765 bytes total<br /> Apr 13 14:14:35 localhost sendmail[5583]: gethostbyaddr(192.168.50.175) failed: 1<br /> Apr 13 14:14:35 localhost sendmail[5584]: starting daemon (8.13.8): SMTP+queueing@01:00:00<br /> Apr 13 14:14:35 localhost sm-msp-queue[5592]: starting daemon (8.13.8): queueing@01:00:00</div>
<p> </p>
<p> </p>
<p>slava1 посылает slava2</p>
<div class="code">Apr 13 14:22:17 localhost sendmail[5850]: m3DAMHFr005850: from=, size=524, class=0, nrcpts=1, msgid=&lt;1547344988.20080414143025@spacedust.ru&gt;, proto=ESMTP, daemon=MTA, relay=[192.168.50.37]<br /> Apr 13 14:22:17 localhost spamd[5280]: spamd: connection from localhost.localdomain [127.0.0.1] at port 2483<br /> Apr 13 14:22:17 localhost spamd[5280]: spamd: setuid to sa-milt succeeded<br /> Apr 13 14:22:17 localhost spamd[5280]: spamd: processing message &lt;1547344988.20080414143025@spacedust.ru&gt; for sa-milt:101<br /> Apr 13 14:22:18 localhost spamd[5280]: spamd: clean message (-98.8/8.0) for sa-milt:101 in 0.2 seconds, 811 bytes.<br /> Apr 13 14:22:18 localhost spamd[5280]: spamd: result: . -98 - ALL_TRUSTED,AWL,DATE_IN_FUTURE_12_24,USER_IN_WHITELIST scantime=0.2,size=811,user=sa-milt,uid=101,required_score=8.0,rhost=localhost.localdomain,raddr=127.0.0.1,rport=2483,mid=&lt;1547344988.20080414143025@spacedust.ru&gt;,autolearn=no<br /> Apr 13 14:22:18 localhost spamd[5278]: prefork: child states: II<br /> Apr 13 14:22:18 localhost sendmail[5854]: m3DAMHFr005850: to=, ctladdr= (502/100), delay=00:00:01, xdelay=00:00:00, mailer=local, pri=31300, dsn=2.0.0, stat=Sent</div>
<p><br /> <br /> slava2 принял почту</p>
<div class="code">Apr 13 14:24:23 localhost dovecot: pop3-login: Login: user=, method=PLAIN, rip=::ffff:192.168.50.37, lip=::ffff:192.168.50.175<br /> Apr 13 14:24:23 localhost dovecot: POP3(slava2): Disconnected: Logged out top=0/0, retr=2/2842, del=2/2, size=2808</div>
<p><br /> <br /> slava1 пытается послать письмо с вирусом slava2</p>
<div class="code">Apr 13 14:30:03 localhost sendmail[5866]: m3DAU2dr005866: from=, size=15415, class=0, nrcpts=1, msgid=&lt;654532184.20080414144355@spacedust.ru&gt;, proto=ESMTP, daemon=MTA, relay=[192.168.50.37] <br /> Apr 13 14:30:03 localhost spamd[5280]: spamd: connection from localhost.localdomain [127.0.0.1] at port 3504                                                                                                           <br /> Apr 13 14:30:03 localhost spamd[5280]: spamd: setuid to sa-milt succeeded                                                                                                                                                  <br /> Apr 13 14:30:03 localhost spamd[5280]: spamd: processing message &lt;654532184.20080414144355@spacedust.ru&gt; for sa-milt:101                                                                                                       <br /> Apr 13 14:30:03 localhost spamd[5280]: spamd: clean message (-99.0/8.0) for sa-milt:101 in 0.3 seconds, 15911 bytes.                                                                                                               <br /> Apr 13 14:30:03 localhost spamd[5280]: spamd: result: . -98 - ALL_TRUSTED,AWL,DATE_IN_FUTURE_12_24,USER_IN_WHITELIST scantime=0.3,size=15911,user=sa-milt,uid=101,required_score=8.0,rhost=localhost.localdomain,raddr=127.0.0.1,rport=3504,mid=&lt;654532184.20080414144355@spacedust.ru&gt;,autolearn=no<br /> Apr 13 14:30:03 localhost spamd[5278]: prefork: child states: II                        <br /> Apr 13 14:30:14 localhost sendmail[5866]: m3DAU2dr005866: Milter: data, discard            <br /> Apr 13 14:30:14 localhost sendmail[5866]: m3DAU2dr005866: discarded</div>
<p> </p>